# claude-sandbox

Sandboxed Docker environment for running Claude Code with read-only access to external services.

## Architecture

```
Host Machine
├── claude-sandbox (launcher script)
│   ├── Builds/manages Docker images (sandbox + proxy)
│   ├── Maps CLAUDE_SANDBOX_* env vars → service-specific vars
│   ├── Ensures settings.json deny list + mcp.json servers on every launch
│   └── Manages proxy lifecycle (start/stop/health check)
│
├── claude-sandbox-proxy (squid container, bridge + internal network)
│   ├── Domain allowlist (allowlist.txt, volume-mounted)
│   ├── Default-deny policy (only HTTP/HTTPS to allowlisted domains)
│   └── Stays running between sandbox sessions
│
└── claude-sandbox (main container, internal network only)
    ├── Claude Code + plugins
    ├── Local MCP servers (codex, gemini, playwright, google-workspace, pylon)
    ├── Language servers (typescript-lsp, pyright, rust-analyzer)
    └── global-agent@3.0.0 routes Node.js traffic through proxy
```

## Key Design Decisions

- **Defense-in-depth for read-only**: Deny list (tool-level) + API restrictions (token scopes) + network filtering (domain allowlist) + Docker isolation
- **CLAUDE_SANDBOX_* env var prefix**: Prevents accidentally passing broad-access tokens from other tools into the sandbox
- **Deny list exact match**: Claude Code uses exact string match for tool names — no globs. Plugin tools use `mcp__claude_ai_Service__tool` prefix, local MCP tools use `mcp__servername__tool` prefix
- **global-agent v3.0.0**: Pinned because v4.x ships TypeScript source without compiled `dist/`. Must NOT upgrade without verifying dist/ exists in the package
- **pylon-mcp --ignore-engines**: Package specifies Node >=24 but compiled JS runs on Node 20. If npm changes --ignore-engines behavior, this could break
- **Proxy network is the real security boundary**: global-agent is just usability (makes Node.js respect proxy vars). Docker `--internal` network blocks all direct internet access regardless

## Deny List (44 tools, last audited 2026-02-19)

| Service | Type | Write Tools Blocked | Prefix |
|---------|------|--------------------:|--------|
| Slack | Plugin | 4 | `mcp__claude_ai_Slack__` |
| Linear | Plugin | 16 | `mcp__claude_ai_Linear__` |
| Notion | Plugin | 7 | `mcp__claude_ai_Notion__` |
| Pylon | Local MCP | 17 | `mcp__pylon__` |
| Fireflies | Plugin | 0 (all read-only) | `mcp__claude_ai_Fireflies__` |

Deny list exists in THREE places (must stay in sync):
1. `Dockerfile` baked-in settings.json (lines 112-165)
2. `claude-sandbox` CREATE path heredoc (fresh install)
3. `claude-sandbox` MERGE path Python script (existing install)

## Credential Flow

```
Host env var                        → Container env var
CLAUDE_SANDBOX_GITHUB_PAT           → GH_TOKEN (gh CLI)
CLAUDE_SANDBOX_GOOGLE_CLIENT_ID     → GOOGLE_OAUTH_CLIENT_ID
CLAUDE_SANDBOX_GOOGLE_CLIENT_SECRET → GOOGLE_OAUTH_CLIENT_SECRET
CLAUDE_SANDBOX_PYLON_API_TOKEN      → PYLON_API_TOKEN
~/.codex/                           → mounted read-only
~/.gemini/                          → mounted read-only
```

## Common Issues

- **global-agent breaking npm/npx**: If `NODE_OPTIONS="--require global-agent/bootstrap"` fails, check that `global-agent` package has a `dist/` directory. v4.x does not.
- **Proxy readiness timeout**: Uses `nc` TCP connect check. If it times out, run `claude-sandbox --cleanup` then retry.
- **Stale mcp.json entries**: The launcher script actively removes known stale servers (slack, linear, notion, github, google-calendar, gmail, gdrive) because local MCP tools bypass the plugin deny list.
- **OAuth plugins**: Must run `claude-sandbox --auth` on the host first — Docker can't open a browser for OAuth callbacks.
- **Playwright @latest**: Fetches latest version from npm on each launch. Supply chain risk accepted for convenience; pin version if concerned.

## Files

| File | Purpose |
|------|---------|
| `Dockerfile` | Main sandbox container (Ubuntu 24.04, Node 20, Rust, Python, all tools) |
| `Dockerfile.proxy` | Squid proxy container (Alpine, minimal) |
| `claude-sandbox` | Launcher script (~750 lines bash + embedded Python) |
| `allowlist.txt` | Domain allowlist for egress proxy |
| `squid.conf` | Squid proxy configuration |
| `network-audit.sh` | Tests egress filtering (allowed + blocked domains) |
| `install.sh` | Symlinks files into ~/.local/bin and ~/.config/claude-sandbox |
| `CLAUDE.md` | Default instructions loaded into every sandbox Claude session |
| `README.md` | User-facing documentation |
