# claude-sandbox egress filter proxy
# Purpose: Allow HTTPS CONNECT and HTTP to allowlisted domains only.
# All other traffic is denied.
#
# Security boundary: The Docker --internal network is the real enforcement.
# Even if squid is misconfigured, the sandbox cannot reach the internet directly.
# Squid provides domain-level filtering for HTTP/HTTPS traffic that passes through.

# --- Listening port ---
http_port 3128

# --- Paths (writable by squid user) ---
pid_filename /var/run/squid/squid.pid

# --- Access control lists ---

# Ports that clients are allowed to CONNECT to
acl SSL_ports port 443
acl Safe_ports port 80
acl Safe_ports port 443
acl CONNECT method CONNECT

# --- Domain allowlist ---
# Each domain entry and its justification is documented in allowlist.txt.
# Use .domain.com syntax to match domain AND all subdomains.
# Use exact domain to match only that domain.

acl allowed_domains dstdomain "/etc/squid/allowlist.txt"

# --- Access rules ---
# Rules are evaluated in order; first match wins.

# Block cache manager access from all clients (prevents config/stats leaks)
http_access deny manager

# Block PURGE method (cache purging not needed; cache is disabled)
acl purge method PURGE
http_access deny purge

# Deny CONNECT to non-SSL ports (prevent proxy abuse)
http_access deny CONNECT !SSL_ports

# Deny requests to non-safe ports
http_access deny !Safe_ports

# Allow requests to allowlisted domains only
http_access allow allowed_domains

# Deny everything else (explicit default-deny)
http_access deny all

# --- Timeouts for long-lived connections ---
# MCP plugins use SSE (Server-Sent Events) over HTTPS CONNECT tunnels.
# These are long-lived connections that must not be prematurely closed.

# Time to wait for the initial connection to the server
connect_timeout 60 seconds

# Maximum time between data reads from the origin server (HTTP only, not CONNECT tunnels)
read_timeout 5 minutes

# Maximum time a client connection can be idle
client_idle_pconn_timeout 5 minutes

# Note: tunnel_timeout was removed in squid 6.x. CONNECT tunnels use read_timeout instead.
# SSE heartbeats are typically every 15-30s so 5 minutes is generous for idle detection.

# --- Performance ---
# We don't need caching -- this is a security proxy, not a performance proxy
cache deny all

# --- Logging ---
# Log to stdout/stderr so docker logs captures it.
# Only log denied requests to reduce noise from high-volume SSE traffic.
access_log stdio:/dev/stdout !allowed_domains
cache_log stdio:/dev/stderr

# --- DNS ---
# Use Docker's embedded DNS (127.0.0.11) so squid resolves container names
# and external domains from the bridge network
dns_nameservers 127.0.0.11

# --- Security hardening ---
# Don't reveal internal network info
forwarded_for delete
# Note: 'via off' is not used because squid 6.x treats it as fatal (HTTP spec requires Via).
# This is fine -- Via header only reveals proxy presence, which is obvious to the client anyway.

# Disable ICP (inter-cache protocol) -- not needed
icp_port 0

# Shutdown lifetime -- how long to wait for active connections on shutdown
shutdown_lifetime 3 seconds
