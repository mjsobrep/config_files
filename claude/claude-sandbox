#!/usr/bin/env bash
# claude-sandbox - Run Claude Code in a sandboxed Docker container
# Drop this in your PATH (e.g., ~/.local/bin/claude-sandbox)

set -e

IMAGE_NAME="claude-sandbox"
CONTAINER_NAME="claude-sandbox-$$"
# Use a host directory instead of Docker volume for auth persistence
# Docker volumes are created as root, causing permission issues with --user
AUTH_DIR="$HOME/.claude-sandbox-auth"

# Colors for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

usage() {
    echo "Usage: claude-sandbox [OPTIONS] [CLAUDE_ARGS...]"
    echo ""
    echo "Run Claude Code in a sandboxed Docker container"
    echo ""
    echo "Options:"
    echo "  -b, --build     Force rebuild the Docker image"
    echo "  -s, --shell     Start a bash shell instead of Claude"
    echo "  -h, --help      Show this help message"
    echo ""
    echo "Examples:"
    echo "  claude-sandbox                    # Start Claude in current directory"
    echo "  claude-sandbox --shell            # Get a shell in the sandbox"
    echo "  claude-sandbox -b                 # Rebuild image and start Claude"
    echo "  claude-sandbox \"fix the tests\"    # Start Claude with initial prompt"
}

build_image() {
    echo -e "${YELLOW}Building Docker image...${NC}"
    
    # Check for Dockerfile in known locations
    DOCKERFILE=""
    if [[ -f "$HOME/.config/claude-sandbox/Dockerfile" ]]; then
        DOCKERFILE="$HOME/.config/claude-sandbox/Dockerfile"
    elif [[ -f "$HOME/.claude-sandbox/Dockerfile" ]]; then
        DOCKERFILE="$HOME/.claude-sandbox/Dockerfile"
    else
        echo -e "${RED}Error: Dockerfile not found${NC}"
        echo "Place Dockerfile.claude-sandbox at one of:"
        echo "  ~/.config/claude-sandbox/Dockerfile"
        echo "  ~/.claude-sandbox/Dockerfile"
        exit 1
    fi

    # Resolve symlink to get actual path (Docker doesn't follow symlinks well)
    DOCKERFILE="$(readlink -f "$DOCKERFILE")"
    echo -e "Using dockerfile at: ${DOCKERFILE}"

    docker build -t "$IMAGE_NAME" -f "$DOCKERFILE" "$(dirname "$DOCKERFILE")"
    echo -e "${GREEN}Image built successfully${NC}"
}

ensure_image() {
    if ! docker image inspect "$IMAGE_NAME" &>/dev/null; then
        echo -e "${YELLOW}Image not found, building...${NC}"
        build_image
    fi
}

ensure_auth_dir() {
    if [[ ! -d "$AUTH_DIR" ]]; then
        echo -e "${YELLOW}Creating auth directory...${NC}"
        mkdir -p "$AUTH_DIR"
    fi
}

# Parse arguments
FORCE_BUILD=false
START_SHELL=false
CLAUDE_ARGS=()

while [[ $# -gt 0 ]]; do
    case $1 in
        -b|--build)
            FORCE_BUILD=true
            shift
            ;;
        -s|--shell)
            START_SHELL=true
            shift
            ;;
        -h|--help)
            usage
            exit 0
            ;;
        *)
            CLAUDE_ARGS+=("$1")
            shift
            ;;
    esac
done

# Build if requested or needed
if [[ "$FORCE_BUILD" == "true" ]]; then
    build_image
else
    ensure_image
fi

ensure_auth_dir

# Determine command to run
if [[ "$START_SHELL" == "true" ]]; then
    CMD="bash"
else
    CMD="claude"
fi

echo -e "${GREEN}Starting sandbox in: $(pwd)${NC}"
echo -e "${YELLOW}Mounted as /workspace (read-write)${NC}"
echo ""

# Run the container
# --user: Run as current user so files created in /workspace have correct ownership on host
# HOME=/home/sandbox: Matches the directory created in Dockerfile (chmod 777 so any UID can write)
# CLAUDE_CONFIG_DIR: Tells Claude where to find/store auth and config
# Auth directory mounted for credential persistence across runs
exec docker run -it --rm \
    --name "$CONTAINER_NAME" \
    --hostname claude-sandbox \
    --user "$(id -u):$(id -g)" \
    -e CLAUDE_CONFIG_DIR=/home/sandbox/.claude \
    -v "$(pwd):/workspace" \
    -v "${AUTH_DIR}:/home/sandbox/.claude" \
    -w /workspace \
    --memory=8g \
    --cpus=4 \
    "$IMAGE_NAME" \
    $CMD "${CLAUDE_ARGS[@]}"
